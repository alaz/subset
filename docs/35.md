# Lens

> "The big deal about lenses is that they are composable. So they are a
  bit cumbersome at first, but they keep gaining ground the more you
  use them. Also, they are great for testability, since you only need
  to test individual lenses, and can take for granted their
  composition." ([Daniel C. Sobral](http://stackoverflow.com/a/5597750/118613))

__Subset__ makes a heavy use of lenses to accumulate updates to
$dbobject$ values and benefits from lenses composability and ability
to update nested structures (since `DBObject` is a nested structure) a
lot.

Lenses in __Subset__ operate on `DBObject` only and for updates (there
is no "getter" part), they
actually boil down to the function `(DBObject => DBObject)` :

```scala
trait DBObjectLens extends (DBObject => DBObject)
```

[`DBObjectLens`]($apiUrl$#com.osinka.subset.DBObjectLens) has the
following methods:

```scala
def get: DBObject
```
> applies the lens to an empty `DBObject`

```scala
def ~ (other: DBObjectLens): DBObjectLens
```
> composes two lenses together. This is equivalent to the composition
  of two functions `f andThen g`
  
```scala
def :~> (dbo: DBObject): DBObject
```
> applies the lens to `dbo`. That is, write all accumulated updates to
  the object.

```scala
def <~: (dbo: DBObject): DBObject
```
> The right-associative version, so that one may write `dbo <~: lens`

A [`DBObjectLens`]($apiUrl$#com.osinka.subset.DBObjectLens\$) companion
object hosts a number of predefined lenses (e.g. writing a value under
some key, removing a key, to name a few), though they are rarely used
directly. Almost everywhere __Subset__ generates `DBObjectLens`: when
one serializes a field's value or builds a query, the result would be
`DBObjectLens` or a subtype. This gives a beautiful flexibility:

* it's very easy to get a fresh $dbobject$ by calling `lens.get`
  (certainly there is also an implicit, that converts lenses into
  `DBObject`)
* it's always possible to apply a lens to the existing $dbobject$, so
  that a developer may modify `DBObject` got from any source and keep
  other fields intact.
* lenses compose, accumulating the changes.

* * *
